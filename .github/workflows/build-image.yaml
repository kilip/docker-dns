---
name: "Build Image"

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build-and-test:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup workflow Variables
        id: vars
        shell: bash
        run: |-
          echo "build_date=$(date --rfc-3339=seconds --utc)" >> $GITHUB_OUTPUT
          echo "goss_args=tail -f /dev/null" >> $GITHUB_OUTPUT
          echo "tag_version=docker-dns:latest" >> $GITHUB_OUTPUT
          echo "tag_testing=docker-dns:testingz" >> $GITHUB_OUTPUT
          echo "tag_rolling=docker-dns:rolling" >> $GITHUB_OUTPUT

      - name: Setup Goss
        uses: e1himself/goss-installation-action@v1.2.1
        with:
          version: v0.3.21

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build container image for testing
        uses: docker/build-push-action@v6
        with:
          build-args: |-
            VERSION=latest
          context: .
          platforms: linux/amd64 # load does not support muti-arch https://github.com/docker/buildx/issues/290
          load: true
          tags: ghcr.io/${{ github.repository_owner }}/${{ steps.vars.outputs.tag_testing }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Goss tests
        id: dgoss
        shell: bash
        env:
          CONTAINER_RUNTIME: docker
          GOSS_FILE: ./docker/goss.yaml
          GOSS_OPTS: --retry-timeout 60s --sleep 2s --color --format documentation
          GOSS_SLEEP: 2
          GOSS_FILES_STRATEGY: cp
          CONTAINER_LOG_OUTPUT: goss_container_log_output
        run: dgoss run ghcr.io/${{ github.repository_owner }}/${{ steps.vars.outputs.tag_testing }} ${{ steps.vars.outputs.goss_args }}

      - name: Build all platforms
        id: release
        uses: docker/build-push-action@v6
        with:
          build-args: |-
            VERSION=${{ steps.vars.outputs.tag_version }}
            CHANNEL=stable
          labels: |-
            ${{ steps.vars.outputs.chan_label_type }}.created="${{ steps.vars.outputs.build_date }}"
            ${{ steps.vars.outputs.chan_label_type }}.title="docker-dns (stable)"
            ${{ steps.vars.outputs.chan_label_type }}.version="${{ steps.vars.outputs.tag_version }}"
            ${{ steps.vars.outputs.chan_label_type }}.authors="Anthonius Munthi <me@itstoni.com>"
            ${{ steps.vars.outputs.chan_label_type }}.url="https://github.com/kilip/docker-dns"
            ${{ steps.vars.outputs.chan_label_type }}.build.url="https://github.com/kilip/docker-dns/actions/runs/${{ github.run_id }}"
            ${{ steps.vars.outputs.chan_label_type }}.documentation="https://github.com/kilip/docker-dns/README.md"
            ${{ steps.vars.outputs.chan_label_type }}.revision="${{ github.sha }}"
          context: .
          platforms: linux/amd64, linux/arm64
          push: true
          tags: |-
            ghcr.io/${{ github.repository_owner }}/${{ steps.vars.outputs.tag_rolling }}
            ghcr.io/${{ github.repository_owner }}/${{ steps.vars.outputs.tag_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
